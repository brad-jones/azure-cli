on:
  push:
    branches:
      - master
  schedule:
    - cron: 13 2 * * *
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - { target: linux-64, os: ubuntu-latest }
          - { target: win-64, os: windows-latest }
          - { target: osx-64, os: macos-15-intel }
          - { target: osx-arm64, os: macos-latest }
    steps:
      - name: ‚¨áÔ∏è Git Checkout
        uses: actions/checkout@v6

      - name: ‚öôÔ∏è Install pixi env
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.61.0
          activate-environment: true

      - run: task build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ./bin
          retention-days: 1
          compression-level: 0

  test:
    needs: [build]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - { target: linux-64, os: ubuntu-latest }
          - { target: win-64, os: windows-latest }
          - { target: osx-64, os: macos-15-intel }
          - { target: osx-arm64, os: macos-latest }
    steps:
      - name: ‚¨áÔ∏è Git Checkout
        uses: actions/checkout@v6

      - name: ‚¨áÔ∏è Download Artifacts from build
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.target }}
          path: ./bin

      # Dont use pixi to ensure we do not bring any python things into the env
      - uses: go-task/setup-task@v1
      - uses: denoland/setup-deno@v2

      - run: task test

  publish:
    needs: [test]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      packages: write
      attestations: write
    steps:
      - name: ‚¨áÔ∏è Git Checkout
        uses: actions/checkout@v6

      - name: ‚öôÔ∏è Install pixi env
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.61.0
          activate-environment: true

      - name: ‚¨áÔ∏è Download Artifacts from build
        uses: actions/download-artifact@v7
        with:
          path: ./bin

      - name: üöÄ Publish Github Release
        run: task publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üîë Upload Attestations
        uses: actions/attest-build-provenance@v3
        if: ${{ hashFiles('./dist/**/*') != '' }}
        with:
          subject-path: |
            ./dist/**/*
